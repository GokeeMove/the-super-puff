# The Super Puff 库存检测工具 - 使用说明

## 系统支持

- ✅ macOS
- ✅ Linux (Debian/Ubuntu/Debian sid)
- ✅ 其他类Unix系统

## 快速开始

### macOS用户

```bash
# 进入项目目录
cd /Users/daboluo/Desktop/project/github_code/the-super-puff

# 激活虚拟环境（已创建好）
source venv/bin/activate

# 运行程序
python check_stock.py
```

### Linux用户

```bash
# 进入项目目录
cd ~/the-super-puff

# 激活虚拟环境
source venv/bin/activate

# 运行程序
python3 check_stock.py
```

### Root用户

如果你是root用户（如服务器环境），程序会自动检测并适配：

```bash
# 进入项目目录
cd /root/the-super-puff

# 首次安装
bash install_linux.sh  # 自动识别root用户，跳过sudo

# 运行程序
./run.sh
```

程序会自动添加root用户所需的Chrome安全参数。

## 程序功能

### 基础功能

程序会自动完成以下操作：

1. ✅ 启动Chrome浏览器（**无界面模式，后台运行**）
2. ✅ 访问The Super Puff商品页面
3. ✅ 等待页面加载完成
4. ✅ 点击"Select a Size"下拉框
5. ✅ 查找Size M选项
6. ✅ 检测Size M是否有货
7. ✅ 显示检测结果

### 高级功能

- **持续监控**: 支持每30分钟自动检测一次
- **微信推送**: 有货时自动推送微信通知 📱
- **后台运行**: 支持后台长期监控
- **多系统支持**: 支持macOS和Linux（Debian/Ubuntu）
- **Root用户**: 自动适配root用户环境

## 快速使用

### 单次检测
```bash
./run.sh
```

### 持续监控
```bash
# 前台运行（可看输出）
./monitor.sh

# 后台运行（推荐）
bash monitor_background.sh    # 启动
bash status_monitor.sh        # 查看状态
bash stop_monitor.sh          # 停止
```

### 配置微信推送

1. **获取密钥**: 访问 https://sct.ftqq.com/ 获取 SendKey
2. **编辑配置**: `vi notify_config.json`，填入密钥
3. **测试推送**: `python3 wechat_notify.py`
4. **开始监控**: `bash monitor_background.sh`

详细说明: [微信推送配置指南](WECHAT_NOTIFY_SETUP.md)

## 检测结果说明

程序会显示以下结果之一：

### 无货
```
❌ Size M 无货 (Sold Out Online)
```

### 有货
```
✅ Size M 有货!
```

### 少量库存
```
✅ Size M 有货! (只剩少量)
```

## 运行示例

### 无货时
```
============================================================
  The Super Puff 库存检测工具 - Size M
============================================================
检测到操作系统: Linux
使用无界面模式运行...
正在启动浏览器（后台模式）...
正在加载页面...
正在检测尺码...

找到Size M，完整文本: 'M
Sold Out Online'

❌ Size M 无货 (Sold Out Online)

检测完成!
============================================================
```

### 有货时
```
============================================================
  The Super Puff 库存检测工具 - Size M
============================================================
检测到操作系统: Linux
使用无界面模式运行...
正在启动浏览器（后台模式）...
正在加载页面...
正在检测尺码...

找到Size M，完整文本: 'M
1 Left'

✅✅✅ Size M 有货! ✅✅✅
    (仅剩1件！)

检测完成!
============================================================
```

## 注意事项

1. **运行时间**：程序需要约15秒完成检测
2. **运行模式**：无界面模式（headless），不会显示浏览器窗口
3. **网络连接**：需要稳定的网络连接访问Aritzia网站
4. **频率限制**：不要过于频繁运行，建议每次检测间隔至少1分钟

## 检测其他颜色

如果需要检测其他颜色的The Super Puff，修改 `check_stock.py` 第19行的URL：

```python
# 当前URL（Modern Taupe颜色）
url = "https://www.aritzia.com/intl/en/product/the-super-puff%E2%84%A2/126464.html?color=6038_3"

# 修改 color 参数即可检测其他颜色
```

## 检测其他尺码

如果需要检测其他尺码（如S、L等），可以修改程序中的尺码匹配逻辑。

在 `check_stock.py` 中搜索：
```python
is_size_m = (
    option_text == 'M' or 
    # ... 其他条件
)
```

将 `'M'` 改为你需要的尺码，例如 `'S'` 或 `'L'`。

## 故障排除

### 问题1: ChromeDriver错误

**macOS:**
```bash
brew install chromedriver
# 或更新
brew upgrade chromedriver
```

**Linux (Debian/Ubuntu):**
```bash
# 方法1: 使用apt安装
sudo apt update
sudo apt install chromium-chromedriver

# 方法2: 检查Chrome版本并下载对应的ChromeDriver
google-chrome --version
# 然后到 https://chromedriver.chromium.org/downloads 下载对应版本
```

### 问题2: 权限错误
确保虚拟环境已激活：
```bash
source venv/bin/activate
```

### 问题3: Linux系统 Chrome无法启动

如果遇到 "Chrome failed to start" 错误：
```bash
# 安装必要的依赖
sudo apt install -y \
    libnss3 \
    libgconf-2-4 \
    libfontconfig1 \
    libxss1 \
    libappindicator1 \
    libasound2

# 检查Chrome是否正确安装
google-chrome --version
```

### 问题4: 页面加载失败
- 检查网络连接
- 确认网站没有更改结构
- 尝试增加等待时间（修改代码中的 `time.sleep()` 值）

### 问题5: Linux系统无界面环境

在完全无GUI的Linux服务器上运行时，确保安装了必要的依赖：
```bash
sudo apt install -y xvfb
# 使用xvfb运行
xvfb-run python3 check_stock.py
```

## 技术细节

- **编程语言**: Python 3.9+
- **主要库**: Selenium WebDriver
- **浏览器**: Chrome + ChromeDriver
- **检测原理**: 
  1. 模拟真实浏览器访问
  2. 自动点击尺码选择器
  3. 解析下拉菜单中的库存状态
  4. 识别"Sold Out Online"等关键词

## 自动化运行

如果需要定期自动检测库存，可以使用macOS的cron或launchd：

```bash
# 编辑crontab
crontab -e

# 添加定时任务（每小时检测一次）
0 * * * * cd /Users/daboluo/Desktop/project/github_code/the-super-puff && source venv/bin/activate && python check_stock.py >> stock_check.log 2>&1
```

## 联系与反馈

如有问题或建议，请检查：
1. Chrome浏览器版本是否与ChromeDriver匹配
2. 网站是否更新了页面结构
3. 网络连接是否稳定
